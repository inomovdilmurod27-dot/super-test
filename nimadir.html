<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Super Test Dasturi (Multimedia + PDF)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    font-family: "Poppins", sans-serif;
    margin:0; padding:0;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color:#333;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding-top:30px;
}
.container {
    width: 900px;
    background:white;
    border-radius:20px;
    box-shadow:0 15px 40px rgba(0,0,0,0.3);
    padding:30px 40px;
}
h1,h2 {
    text-align:center;
    margin-bottom:20px;
    color:#333;
}
h1 { font-size:2em; }
h2 { font-size:1.5em; }
input[type="text"], input[type="number"], textarea, select {
    width:100%; padding:10px 12px;
    margin:8px 0;
    border-radius:10px;
    border:1px solid #ccc;
    font-size:15px;
    transition:0.2s;
}
input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
    border-color:#667eea;
    box-shadow:0 0 5px rgba(102,126,234,0.5);
    outline:none;
}
button {
    background:linear-gradient(90deg,#667eea,#764ba2);
    border:none;
    color:white;
    padding:12px 25px;
    margin:10px 0;
    border-radius:12px;
    font-size:16px;
    cursor:pointer;
    transition:0.3s;
}
button:hover {
    background:linear-gradient(90deg,#764ba2,#667eea);
}
.question-box {
    padding:20px;
    margin:15px 0;
    border-radius:15px;
    background:#f9f9f9;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.result-box {
    background:#e0f7e9;
    padding:20px;
    border-left:6px solid #34c759;
    border-radius:10px;
    margin-top:20px;
}
label {
    display:block;
    margin:6px 0;
    cursor:pointer;
    font-size:15px;
}
.hidden { display:none; }
.admin-options {
    display:flex;
    flex-wrap:wrap;
    gap:15px;
    margin-bottom:20px;
}
.admin-options label {
    flex:1;
}
#timer {
    font-weight:bold;
    font-size:16px;
    margin-bottom:15px;
    color:#764ba2;
}
.media-input {
    margin:5px 0 10px 0;
}
</style>
</head>
<body>

<div class="container">
    <h1>ðŸ“˜ Super Test Dasturi</h1>

    <!-- ADMIN PANEL -->
    <div id="adminPanel">
        <h2>Admin panel â€” Worddan savol import qilish</h2>

        <input type="file" id="wordFile" accept=".docx">
        <button onclick="importWord()">ðŸ“„ Worddan savol import qilish</button>

        <div class="admin-options">
            <label>
                <input type="checkbox" id="shuffleQuestions"> Savollar aralashsin
            </label>
            <label>
                Test vaqti: 
                <input type="number" id="testMinutes" min="0" placeholder="Daqiqa"> m
                <input type="number" id="testSeconds" min="0" max="59" placeholder="Sekund"> s
            </label>
            <label>
                Test uchun savollar soni: 
                <input type="number" id="quizSize" min="1" placeholder="Masalan: 30">
            </label>
        </div>

        <h3>âœ… Qoâ€˜shilgan savollar: <span id="questionCount">0</span></h3>
        <div id="questionList"></div>

        <button onclick="startQuiz()">âœ… Testni boshlash</button>
    </div>

    <!-- QUIZ PANEL -->
    <div id="quizPanel" class="hidden">
        <h2>ðŸ“˜ Test</h2>
        <div id="quizContainer"></div>
        <button onclick="finishQuiz()">âœ… Natijani koâ€˜rsatish</button>
    </div>

    <!-- RESULT -->
    <div id="resultPanel" class="hidden">
        <h2>Natija</h2>
        <div id="resultBox"></div>

        <div class="nav-btns">
            <button onclick="exportWord()">ðŸ“„ Wordga yuklash (faqat savol)</button>
            <button onclick="exportPDF()">ðŸ“„ PDF hisobot</button>
            <button onclick="location.reload()">ðŸ”„ Qayta boshlash</button>
        </div>
    </div>

</div>

<script>
let quizData = [];

// WORDDAN IMPORT
function importWord() {
    const fileInput = document.getElementById('wordFile');
    const file = fileInput.files[0];
    if (!file) return alert("Word faylni tanlang!");

    const reader = new FileReader();
    reader.onload = function(event) {
        const arrayBuffer = event.target.result;
        mammoth.extractRawText({arrayBuffer: arrayBuffer})
        .then(function(result) {
            let text = result.value;
            let lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");

            let currentQuestion = null;

            lines.forEach(line => {
                if(line.startsWith("++++")) {
                    currentQuestion = {question: line.substring(4).trim(), options: [], answer: [], media: {}};
                    quizData.push(currentQuestion);
                    document.getElementById("questionList").innerHTML += `
                        <div class="question-box">
                            <b>Savol:</b> ${currentQuestion.question}
                        </div>
                    `;
                } else if (line.startsWith("====#") && currentQuestion) {
                    currentQuestion.options.push(line.substring(5).trim());
                    currentQuestion.answer.push(currentQuestion.options.length - 1);
                } else if (line.startsWith("====") && currentQuestion) {
                    currentQuestion.options.push(line.substring(4).trim());
                }
            });

            document.getElementById("questionCount").textContent = quizData.length;
            alert("Word fayldagi savollar muvaffaqiyatli qoâ€˜shildi!");
        })
        .catch(err => alert("Xatolik: " + err));
    };
    reader.readAsArrayBuffer(file);
}

// TESTNI BOSHLASH
function startQuiz() {
    if (quizData.length === 0) return alert("Avval savollar qoâ€˜shing!");

    let quizSize = parseInt(document.getElementById("quizSize").value);
    if (isNaN(quizSize) || quizSize < 1) quizSize = quizData.length;
    if (quizSize > quizData.length) quizSize = quizData.length;

    let tempQuestions = [...quizData];
    if(document.getElementById("shuffleQuestions").checked || quizSize < quizData.length) {
        tempQuestions = tempQuestions.sort(() => Math.random() - 0.5);
    }

    const selectedQuestions = tempQuestions.slice(0, quizSize);

    document.getElementById("adminPanel").classList.add("hidden");
    document.getElementById("quizPanel").classList.remove("hidden");

    let html = "";
    selectedQuestions.forEach((q, idx) => {
        let multiText = q.answer.length > 1 ? `<div style="color:#764ba2; font-style:italic; margin-bottom:5px;">Iltimos, ${q.answer.length} ta variantni tanlang</div>` : "";
        html += `<div class="question-box">
                    <b>${idx+1}. ${q.question}</b><br>
                    ${multiText}
                    ${q.options.map((opt, i) => `
                        <label>
                            <input type="checkbox" name="q${idx}" value="${i}">
                            ${opt}
                        </label><br>
                    `).join("")}
                 </div>`;
    });

    document.getElementById("quizContainer").innerHTML = html;

    const totalEl = document.createElement("div");
    totalEl.style.fontWeight = "bold";
    totalEl.style.margin = "10px 0";
    totalEl.textContent = `Savollar soni: ${selectedQuestions.length}`;
    document.getElementById("quizContainer").prepend(totalEl);

    const minutes = parseInt(document.getElementById("testMinutes").value) || 0;
    const seconds = parseInt(document.getElementById("testSeconds").value) || 0;
    let timeLeft = minutes * 60 + seconds;

    if(timeLeft > 0) {
        const timerEl = document.createElement("div");
        timerEl.id = "timer";
        document.getElementById("quizContainer").prepend(timerEl);

        const interval = setInterval(() => {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            timerEl.textContent = `Qolgan vaqt: ${m}m ${s}s`;
            timeLeft--;
            if(timeLeft < 0) {
                clearInterval(interval);
                alert("Vaqt tugadi! Test yakunlandi.");
                finishQuiz(selectedQuestions);
            }
        }, 1000);
    }
}

// NATIJANI HISOBLASH
function finishQuiz(selectedQuestions = quizData) {
    let score = 0;
    let resultHTML = "";

    selectedQuestions.forEach((q, idx) => {
        const selectedEls = document.querySelectorAll(`input[name="q${idx}"]:checked`);
        const selectedIndexes = Array.from(selectedEls).map(el => parseInt(el.value));

        const correctSet = new Set(q.answer);
        const selectedSet = new Set(selectedIndexes);

        let isCorrect = selectedSet.size === correctSet.size && [...selectedSet].every(v => correctSet.has(v));
        if (isCorrect) score++;

        resultHTML += `<div class="question-box">
            <b>${idx+1}. ${q.question}</b><br>
            Sizning javobingiz: <b>${selectedIndexes.length>0 ? selectedIndexes.map(i=>q.options[i]).join(", ") : "Belgilanmagan"}</b><br>
            Toâ€˜gâ€˜ri javob: âœ… <b>${q.answer.map(i=>q.options[i]).join(", ")}</b>
        </div>`;
    });

    document.getElementById("resultBox").innerHTML = `<div class="result-box">Umumiy natija: <b>${score} / ${selectedQuestions.length}</b></div>` + resultHTML;

    document.getElementById("quizPanel").classList.add("hidden");
    document.getElementById("resultPanel").classList.remove("hidden");
}

// WORD EXPORT
function exportWord() {
    let content = "TEST SAVOLLARI\n\n";
    quizData.forEach((q, idx) => {
        content += `${idx+1}. ${q.question}\n\n`;
    });

    const blob = new Blob([content], { type: "application/msword;charset=utf-8" });
    saveAs(blob, "Test_savollari.doc");
}

// PDF HISOBOT
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text("TEST NATIJALARI", 105, 10, null, null, "center");

    let y = 20;
    quizData.forEach((q, idx) => {
        if(y > 270){ doc.addPage(); y=20; }
        doc.setFontSize(12);
        doc.text(`${idx+1}. ${q.question}`, 10, y);
        y += 7;
        q.options.forEach((opt, i) => {
            doc.text(`- ${opt}`, 15, y);
            y += 6;
        });
        y += 5;
    });

    doc.save("Test_natijalari.pdf");
}
</script>

</body>
</html>
